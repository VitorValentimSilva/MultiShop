generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Permission {
  id    String @id @default(uuid())
  key   String @unique
  label String

  translations PermissionTranslation[]
  roles        RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PermissionTranslation {
  id     String @id @default(uuid())
  locale String
  label  String

  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([permissionId, locale])
}

model Tenant {
  id                   String  @id @default(uuid())
  slug                 String  @unique
  name                 String
  isActive             Boolean @default(true)
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  subscriptionStatus   String?
  planId               String?

  users    User[]
  roles    Role[]
  accounts Account[]
  sessions Session[]
  plan     Plan?     @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  tenantId      String

  tenant   Tenant     @relation(fields: [tenantId], references: [id])
  roles    UserRole[]
  accounts Account[]
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([email, tenantId])
  @@index([tenantId])
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  tenantId          String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([provider, providerAccountId, tenantId])
  @@index([userId])
  @@index([tenantId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  tenantId     String
  expires      DateTime

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([tenantId])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

model Role {
  id       String @id @default(uuid())
  name     String
  tenantId String

  tenant       Tenant            @relation(fields: [tenantId], references: [id])
  translations RoleTranslation[]
  permissions  RolePermission[]
  users        UserRole[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, tenantId])
  @@index([tenantId])
}

model RoleTranslation {
  id          String  @id @default(uuid())
  locale      String
  name        String
  description String?
  roleId      String

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, locale])
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

enum BillingInterval {
  MONTH
  YEAR
  ONE_TIME
}

model Plan {
  id              String  @id @default(uuid())
  key             String  @unique
  active          Boolean @default(true)
  stripeProductId String?

  translations PlanTranslation[]
  prices       PlanPrice[]
  features     PlanFeature[]
  reviews      Review[]
  tenants      Tenant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PlanPrice {
  id            String          @id @default(uuid())
  planId        String
  amountCents   Int
  currency      String
  interval      BillingInterval @default(MONTH)
  stripePriceId String?         @unique
  active        Boolean         @default(true)

  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, currency, interval])
  @@index([planId])
  @@index([stripePriceId])
}

model PlanTranslation {
  id          String  @id @default(uuid())
  locale      String
  title       String
  subtitle    String?
  description String? @db.Text
  planId      String

  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, locale])
}

model Feature {
  id    String @id @default(uuid())
  key   String @unique
  order Int?

  translations FeatureTranslation[]
  planFeatures PlanFeature[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FeatureTranslation {
  id          String  @id @default(uuid())
  locale      String
  title       String
  description String? @db.Text
  featureId   String

  feature Feature @relation(fields: [featureId], references: [id])

  @@unique([featureId, locale])
}

model PlanFeature {
  planId     String
  featureId  String
  included   Boolean @default(true)
  note       String?
  limitValue Int?
  limitUnit  String?

  plan    Plan    @relation(fields: [planId], references: [id], onDelete: Cascade)
  feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@id([planId, featureId])
  @@index([featureId])
}

model Review {
  id          String  @id @default(uuid())
  rating      Int
  title       String?
  message     String? @db.Text
  authorName  String?
  authorEmail String?
  locale      String?
  isPublished Boolean @default(true)
  planId      String?

  plan Plan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DomainMetric {
  id        String  @id @default(uuid())
  key       String
  namespace String?
  value     Decimal @db.Decimal(30, 6)
  unit      String?
  meta      Json?

  createdAt DateTime @default(now())

  @@unique([key, namespace])
  @@index([key])
}
